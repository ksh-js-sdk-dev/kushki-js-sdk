
name: Deployment

on:
  pull_request:
    branches:
      - "release/*"
      - "develop"
      - "master"
    types: [closed]

  workflow_dispatch:

jobs:
  build-version:
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.generate-version.outputs.new-version }}
      branch: ${{ steps.generate-version.outputs.branch }}
    steps:
      - name: Get code
        uses: actions/checkout@v3

      - name: Load & cache dependencies
        id: generate-version
        uses: ./.github/actions/generate-version

      - name: Log GITHUB_ENV
        run: |
          echo "GET_VERSION is $GET_VERSION"          
          echo "source_branch is ${{ steps.extract-number-branch.outputs.source_branch }}"
          echo "branch is ${{ steps.extract-number-branch.outputs.branch }}"
          echo "BRANCH_NUMBER is $BRANCH_NUMBER"
          echo "NUMBER_BRANCH is $NUMBER_BRANCH"
          echo "new-version is ${{ steps.version.outputs.new-version }}"          

  build:
    needs: build-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
    steps:
      - name: Get code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 18.x

      - name: Set new version in package.json
        id: version
        run: |
          NEW_VERSION=${{ needs.build-version.outputs.new-version }}
          BRANCH=${{ needs.build-version.outputs.branch }}
          echo "NEW_VERSION is $NEW_VERSION"
          echo "BRANCH is $BRANCH"
          echo "new-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"